<?xml version="1.0"?>
<project name="Scriptographer" default="usage" basedir=".">
	<!-- =================================================================== -->
	<!-- Initializes some variables                                          -->
	<!-- =================================================================== -->
	<target name="init">
		<property name="Name" value="Scriptographer"/>
		<property name="version.major" value ="2" />
		<property name="version.minor" value="1" />
		<property name="version" value="${version.major}.${version.minor}"/>
		<property name="project" value="scriptographer"/>
		<tstamp>
			<!-- get current year -->
			<format property="now" pattern="yyyy"/>
			<format property="date" pattern="yyyy_MM_dd"/>
		</tstamp>
		<property name="year" value="2001-${now}"/>

		<property name="home.dir" value="../.."/>
		<!-- build.lib contains libraries for building, not built libs. -->
		<!-- build.libraries contains the products. TODO: find better names. -->
		<property name="build.lib" value="${home.dir}/build/java/lib"/>
		<property name="build.dir" value="${home.dir}/build/java/build"/>
		<property name="build.src" value="${home.dir}/src/java"/>
		<property name="build.jni" value="${home.dir}/src/native/jni"/>
		<property name="build.classes" value="${build.dir}/classes"/>
		<property name="build.libraries" value="${build.dir}/lib"/>
		<property name="build.packages" value="${home.dir}/build/packages"/>
		<loadproperties srcfile="build.number"/>
		<condition property="build.platform.mac">
	    	<os family="mac"/>
		</condition>
		<condition property="build.platform.win">
	    	<os family="windows"/>
		</condition>
		<path id="build.classpath">
			<fileset dir="${build.libraries}">
				<include name="**/*.jar" />
				<exclude name="**/scriptographer*.jar" />
			</fileset>
		</path>

		<property name="docs.dir" value="${home.dir}/docs"/>
		<property name="docs.api.dir" value="${docs.dir}/api"/>
		<property name="docs.js.dir" value="${docs.dir}/js"/>
		<property name="docs.templates.dir" value="${docs.dir}/templates"/>
		<!-- this is used for importing comments from the gnu classpath file into the js documentation -->
		<property name="docs.src" value="${docs.dir}/src"/>
		
		<path id="docs.sourcepath" >
			<pathelement location="${build.src}" />
			<pathelement location="${docs.src}" />
		</path>

		<path id="docs.classpath">
			<pathelement path="${build.classes}"/>
			<fileset dir="${build.lib}">
				<include name="**/*.jar" />
			</fileset>
			<fileset dir="${build.libraries}">
				<include name="**/*.jar" />
				<exclude name="**/scriptographer*.jar" />
			</fileset>
		</path>

		<property name="scripts.dir" value="${home.dir}/scripts"/>

		<property name="jar.name" value="${project}"/>
		<property name="package.name" value="${project}-${version}"/>

		<property name="debug" value="off"/>
		<property name="optimize" value="on"/>
		<property name="target" value="1.5"/>
		<property name="deprecation" value="off"/>
	</target>


	<!-- =================================================================== -->
	<!-- Help on usage                                                       -->
	<!-- =================================================================== -->
	<target name="help" depends="usage" />
	<target name="usage">
		<echo message=""/>
		<echo message=""/>
		<echo message="Scriptographer build instructions"/>
		<echo message="-------------------------------------------------------------"/>
		<echo message=""/>
		<echo message=" available targets are:"/>
		<echo message=""/>
		<echo message=" compile    --> compiles the source code to ./classes"/>
		<echo message=" jar        --> generates the ./lib/scriptographer.jar file"/>
		<echo message=" install    --> installs the jar files in the Adobe Illustrator directory "/>
		<echo message=" jni        --> generates jni headers and registerNatives.cpp in ./jni/"/>
		<echo message=" jnibodies  --> generates empty jni bodies in ./jni/"/>
		<echo message=" javadocs   --> generates the API docs"/>
		<echo message=" docs       --> tries to retrieve the HTML documentation "/>
		<echo message="                (may need proxy settings in startscript)"/>
		<echo message=""/>
		<echo message=" usage	    --> provides help on using the build tool (default)"/>
		<echo message=""/>
		<echo message=" See comments inside the build.xml file for more details."/>
		<echo message="-------------------------------------------------------------"/>
		<echo message=""/>
		<echo message=""/>
	</target>


	<!-- =================================================================== -->
	<!-- Compiles the source directory                                       -->
	<!-- =================================================================== -->
	<target name="compile" depends="init">
		<mkdir dir="${build.classes}"/>
		<!-- copy the icc profiles -->
		<copy todir="${build.classes}/com/scriptographer/cmm">
			<fileset dir="${build.src}/com/scriptographer/cmm">
				<include name="**/*.icc" />
			</fileset>
		</copy>
		<!-- copy the meta resources -->
		<copy todir="${build.classes}/META-INF">
			<fileset dir="${build.src}/META-INF">
				<exclude name="**/*.in" />
			</fileset>
		</copy>
		<javac srcdir="${build.src}"
			destdir="${build.classes}"
			debug="${debug}"
			deprecation="${deprecation}"
			optimize="${optimize}"
			source="${target}"
			target="${target}">
			<classpath refid="build.classpath" />
			<exclude name="**/global.java"/>
		</javac>
	</target>


	<!-- =================================================================== -->
	<!-- Creates scriptographer.jar and loader.jar in the lib-directory      -->
	<!-- =================================================================== -->
	<target name="jar" depends="compile">
		<copy todir="${build.classes}/com/scriptographer/cmm">
			<fileset dir="${build.src}/com/scriptographer/cmm">
				<include name="**/*.icc" />
			</fileset>
		</copy>
		<copy todir="${build.classes}/com/scriptographer/adm/resources">
			<fileset dir="${build.src}/com/scriptographer/adm/resources">
				<include name="**/*.png" />
			</fileset>
		</copy>
		<jar jarfile="${build.libraries}/${jar.name}.jar"
			basedir="${build.classes}"
			excludes="**/loader/**,**/test/**,**/jython/**"/>
		<jar jarfile="${build.dir}/loader.jar"
			basedir="${build.classes}"
			includes="**/loader/**"/>
	</target>


	<!-- =================================================================== -->
	<!-- Increases the build.number by one. Execute only before publishing   -->
	<!-- a new version.                                                      -->
	<!-- =================================================================== -->
	<target name="buildnumber" depends="init">
		<propertyfile file="build.number" comment="Build Number for Scriptographer Plugin.">
			  <entry  key="build.number" type="int" default="000" operation="+" pattern="000" />
		</propertyfile>
		<antcall target="resources" />
	</target>
	
	<target name="resources" depends="init">
		<property name="resources.mac" value="${home.dir}/build/mac/resources" />
		<property name="resources.win" value="${home.dir}/build/win/resources" />
		<property name="resources.meta" value="${build.src}/META-INF/" />
		<copy file="${resources.mac}/Info.plist.in" tofile="${resources.mac}/Info.plist" overwrite="true" />
		<replace file="${resources.mac}/Info.plist">
			<replacefilter token="@version@" value="${version}" />
			<replacefilter token="@build.number@" value="${build.number}" />
			<replacefilter token="@year@" value="${year}" />
		</replace>
		<copy file="${resources.win}/plugin.rc.in" tofile="${resources.win}/plugin.rc" overwrite="true" />
		<replace file="${resources.win}/plugin.rc">
			<replacefilter token="@version.major@" value="${version.major}" />
			<replacefilter token="@version.minor@" value="${version.minor}" />
			<replacefilter token="@build.number@" value="${build.number}" />
			<replacefilter token="@year@" value="${year}" />
		</replace>
		<copy file="${resources.meta}/services/com.scriptographer.ScriptographerEngine.in" tofile="${resources.meta}/services/com.scriptographer.ScriptographerEngine" overwrite="true" />
		<replace file="${resources.meta}/services/com.scriptographer.ScriptographerEngine">
			<replacefilter token="@version@" value="${version}" />
			<replacefilter token="@build.number@" value="${build.number}" />
		</replace>
	</target>
	
	<!-- =================================================================== -->
	<!-- Creates install packages of Scriptographer for download             -->
	<!-- =================================================================== -->
	<target name="packages" depends="jar">
		<mkdir dir="${build.packages}"/>

		<mkdir dir="${build.packages}/Scriptographer"/>
		<mkdir dir="${build.packages}/Scriptographer/java"/>
		<copy todir="${build.packages}/Scriptographer/java">
			<fileset dir="${build.dir}">
				<include name="**/loader.jar"/>
				<include name="**/${jar.name}.jar"/>
				<include name="**/js.jar"/>
				<exclude name="**/jython.jar"/>
				<!-- Copy the platform independent RXTX stuff here -->
				<include name="**/rxtx.jar"/>
			</fileset>
		</copy>

		<!-- GUI -->
		<copy todir="${build.packages}/Scriptographer/gui">
			<fileset dir="${home.dir}/src/js/gui"/>
		</copy>

		<!-- JS Docs -->
		<copy todir="${build.packages}/Scriptographer/doc">
			<fileset dir="${docs.js.dir}"/>
		</copy>

		<!-- Scripts -->
		<copy todir="${build.packages}/Scriptographer/scripts">
			<fileset dir="${scripts.dir}">
				<exclude name="**/*.ai"/>
			</fileset>
		</copy>

		<antcall target="packages.platform" />

		<!-- Remove everything except the archives -->
		<delete includeEmptyDirs="true">
			<fileset dir="${build.packages}">
				<exclude name="**/Scriptographer*.zip"/>
				<exclude name="**/Scriptographer*.dmg"/>
			</fileset>
		</delete>
	</target>

	<!-- =================================================================== -->
	<!-- Platform Specific Package related Tasks for Mac and Windows         -->
	<!-- =================================================================== -->
	<target name="packages.platform" depends="packages.platform.mac,packages.platform.win">
	</target>

	<target name="packages.platform.mac" depends="init" if="build.platform.mac">
		<echo>Executing Mac specific tasks</echo>

		<!-- Copy platform dependent RXTX stuff -->
		<copy todir="${build.packages}/Scriptographer/java">
			<fileset dir="${build.dir}">
				<include name="**/librxtxSerial.jnilib"/>
			</fileset>
		</copy>

		<!-- Make the packages -->
		<exec executable="${home.dir}/build/mac/zipPackages.sh" dir="${build.packages}">
			<arg path="${home.dir}/build/mac/build"/>
			<arg line="${version}.${build.number}"/>
		</exec>
	</target>

	<target name="packages.platform.win" depends="init" if="build.platform.win">
		<echo>Executing Windows specific tasks</echo>

		<!-- Copy platform dependent RXTX stuff -->
		<copy todir="${build.packages}/Scriptographer/java">
			<fileset dir="${build.dir}">
				<include name="**/rxtxSerial.dll"/>
			</fileset>
		</copy>

		<!-- Make the packages -->
		<exec executable="cmd.exe" dir="${build.packages}">
			<arg line="/C"/>
			<arg path="${home.dir}/build/win/zipPackages.bat"/>
			<arg path="${home.dir}/build/win"/>
			<arg line="${version}.${build.number}"/>
		</exec>
	</target>

	<!-- =================================================================== -->
	<!-- Compiles the source directory                                       -->
	<!-- =================================================================== -->
	<target name="jniheaders" depends="compile">
		<mkdir dir="${build.jni}"/>
		<javah destdir="${build.jni}" classpath="${build.classes}">
			<classpath refid="build.classpath" />

			<class name="com.scriptographer.ScriptographerEngine" />

			<class name="com.scriptographer.ai.Tool" />
			<class name="com.scriptographer.ai.Item" />
			<class name="com.scriptographer.ai.Path" />
			<class name="com.scriptographer.ai.PathStyle" />
			<class name="com.scriptographer.ai.Group" />
			<class name="com.scriptographer.ai.Raster" />
			<class name="com.scriptographer.ai.PlacedItem" />
			<class name="com.scriptographer.ai.SegmentList" />
			<class name="com.scriptographer.ai.Curve" />
			<class name="com.scriptographer.ai.ItemSet" />
			<class name="com.scriptographer.ai.Layer" />
			<class name="com.scriptographer.ai.LayerList" />
			<class name="com.scriptographer.ai.Dictionary" />
			<class name="com.scriptographer.ai.Document" />
			<class name="com.scriptographer.ai.DocumentList" />
			<class name="com.scriptographer.ai.DocumentView" />
			<class name="com.scriptographer.ai.DocumentViewList" />
			<class name="com.scriptographer.ai.Color" />
			<class name="com.scriptographer.ai.Pathfinder" />
			<class name="com.scriptographer.ai.LiveEffect" />
			<class name="com.scriptographer.ai.Timer" />
			<class name="com.scriptographer.ai.Annotator" />
			<class name="com.scriptographer.ai.TextFrame" />
			<class name="com.scriptographer.ai.PointText" />
			<class name="com.scriptographer.ai.AreaText" />
			<class name="com.scriptographer.ai.PathText" />
			<class name="com.scriptographer.ai.TextRange" />
			<class name="com.scriptographer.ai.TextStory" />
			<class name="com.scriptographer.ai.TextStoryList" />
			<class name="com.scriptographer.ai.CharacterStyle" />
			<class name="com.scriptographer.ai.ParagraphStyle" />
			<class name="com.scriptographer.ai.FontList" />
			<class name="com.scriptographer.ai.FontFamily" />
			<class name="com.scriptographer.ai.FontWeight" />
			<class name="com.scriptographer.ai.Tracing" />
			<class name="com.scriptographer.ai.Pattern" />
			<class name="com.scriptographer.ai.PatternList" />
			<class name="com.scriptographer.ai.Symbol" />
			<class name="com.scriptographer.ai.SymbolList" />
			<class name="com.scriptographer.ai.SymbolItem" />
			<class name="com.scriptographer.ai.Swatch" />
			<class name="com.scriptographer.ai.SwatchList" />
			<class name="com.scriptographer.ai.Gradient" />
			<class name="com.scriptographer.ai.GradientList" />
			<class name="com.scriptographer.ai.GradientStopList" />
			<class name="com.scriptographer.ai.FileFormat" />

			<class name="com.scriptographer.adm.Notifier" />
			<class name="com.scriptographer.adm.Dialog" />
			<class name="com.scriptographer.adm.ModalDialog" />
			<class name="com.scriptographer.adm.Item" />
		   	<class name="com.scriptographer.adm.ValueItem" />
		   	<class name="com.scriptographer.adm.TextValueItem" />
		   	<class name="com.scriptographer.adm.TextItem" />
		   	<class name="com.scriptographer.adm.Button" />
			<class name="com.scriptographer.adm.ToggleItem" />
			<class name="com.scriptographer.adm.ItemGroup" />
		   	<class name="com.scriptographer.adm.ImageStatic" />
		   	<class name="com.scriptographer.adm.TextEditItem" />

		   	<class name="com.scriptographer.adm.ListItem" />
		   	<class name="com.scriptographer.adm.ListEntry" />
		   	<class name="com.scriptographer.adm.HierarchyList" />
		   	<class name="com.scriptographer.adm.HierarchyListEntry" />

		   	<class name="com.scriptographer.adm.Drawer" />
		   	<class name="com.scriptographer.adm.Image" />
		   	<class name="com.scriptographer.adm.Tracker" />

			<class name="com.scriptographer.adm.MenuItem" />
			<class name="com.scriptographer.adm.MenuGroup" />

			<class name="com.scriptographer.adm.Key" />
		</javah>
		<echo id="echo" level="info" />
		<script language="javascript" src="scripts/jni.js">
		<![CDATA[
			// create registerNatives.cpp by parsing the generated files by javah, see jni.js:
			registerNatives(project.getProperty("build.jni"), project.getProperty("build.jni") + "/registerNatives.cpp");
		]]>
		</script>
	</target>


	<!-- =================================================================== -->
	<!-- Compiles the source directory                                       -->
	<!-- =================================================================== -->
	<target name="jnibodies" depends="jniheaders">
		<script language="javascript" src="scripts/jni.js">
		<![CDATA[
			// create jni bodies by parsing the generated files by javah, see jni.js:
			createJniBodies(project.getProperty("build.jni"));
		]]>
		</script>
	</target>


	<!-- =================================================================== -->
	<!-- Creates the API documentation                                       -->
	<!-- =================================================================== -->
	<target name="javadocs" depends="init">
		<mkdir dir="${docs.api.dir}"/>
		<javadoc packagenames="com.scriptographer.*"
  				sourcepathref="docs.sourcepath"
				destdir="${docs.api.dir}"
				author="false"
				version="false"
				private="false"
				windowtitle="${Name} ${version} API"
				classpathref="build.classpath">
		    <doctitle><![CDATA[${Name} ${version}]]></doctitle>
		    <bottom><![CDATA[Copyright &#169; ${year} J&uuml;rg Lehni, <a href="http://www.scratchdisk.com" target="_blank">Scratchdisk.com</a>. All Rights Reserved.]]></bottom>
		</javadoc>
	</target>

	<!-- =================================================================== -->
	<!-- The doclet that produces both JS documentation and templates        -->
	<!-- Do not call directly, use it through jsdocs / templatedocs          -->
	<!-- =================================================================== -->
	<target name="rhinodoclet" depends="init">
		<mkdir dir="${destdir}"/>
		<!--
		<javadoc packagenames="com.scriptographer.test"
		-->
		<javadoc packagenames="com.scriptographer,com.scriptographer.sg,com.scriptographer.ai,com.scriptographer.adm,com.scriptographer.util,java.*"
				sourcepathref="docs.sourcepath"
				destdir="${destdir}"
				author="false"
				version="false"
				public="true"
				windowtitle="${Name} ${version} API"
				classpathref="docs.classpath">
		    <doctitle><![CDATA[${Name} ${version}]]></doctitle>
			<bottom><![CDATA[Copyright &#169; ${year} J&uuml;rg Lehni, <a href="http://www.scratchdisk.com" target="_blank">Scratchdisk.com</a>. All Rights Reserved.]]></bottom>
			<doclet name="com.scratchdisk.script.rhino.RhinoDoclet" pathref="docs.classpath">
				<param name="-script" value="doclet/doclet.js"/>
				<param name="-basepackage" value="com.scriptographer"/>
				<param name="-filterclasses" value="
					com.scriptographer.ai.DocumentObject
					com.scriptographer.ai.ItemPoint
					com.scriptographer.ai.ItemRectangle
					com.scriptographer.ai.Dictionary
					com.scriptographer.ai.Event
					com.scriptographer.ai.FileFormat
					com.scriptographer.ai.Style
					com.scriptographer.ai.TabletValue
					com.scriptographer.ai.Tool
					com.scriptographer.adm.Point
					com.scriptographer.adm.Rectangle
					com.scriptographer.adm.Size
					com.scriptographer.adm.Notifier
					com.scriptographer.adm.DialogGroupInfo
					com.scriptographer.sg.Preferences
					com.scriptographer.js.*
					com.scriptographer.util.*
					java.*
				"/>
				<param name="-packagesequence" value="
					com.scriptographer.sg
					com.scriptographer.ai
					com.scriptographer.adm
					com.scriptographer.test
					"/>
				<param name="-methodfilter" value="
					iterator
					hashCode
					destroyAll
					disposeAll
					removeAll
				"/>
				<param name="-classorder" value="doclet/classorder.txt"/>
				<param name="-templates" value="${templates}"/>
				<param name="-nosummaries" value="true" />
			</doclet>
		</javadoc>
	</target>

	<!-- =================================================================== -->
	<!-- Creates the JS API documentation                                    -->
	<!-- =================================================================== -->
	<target name="jsdocs" depends="init">
		<mkdir dir="${docs.js.dir}/packages"/>
		<antcall target="rhinodoclet">
			<param name="templates" value="false"/>
			<param name="destdir" value="${docs.js.dir}"/>
		</antcall>
	</target>

	<!-- =================================================================== -->
	<!-- Creates the JS API documentation as Templates for the Server        -->
	<!-- =================================================================== -->
	<target name="templatedocs" depends="init">
		<antcall target="rhinodoclet">
			<param name="templates" value="true"/>
			<param name="destdir" value="${docs.templates.dir}"/>
		</antcall>
	</target>
</project>

