<?xml version="1.0"?>
<project name="Scriptographer" default="usage" basedir=".">
	<!-- =================================================================== -->
	<!-- Initializes some variables                                          -->
	<!-- =================================================================== -->
	<target name="init">
		<property name="Name" value="Scriptographer"/>
		<property name="version.major" value ="2" />
		<property name="version.minor" value="0" />
		<property name="version" value="${version.major}.${version.minor}"/>
		<property name="project" value="scriptographer"/>
		<tstamp>
			<!-- get current year -->
			<format property="now" pattern="yyyy"/>
			<format property="date" pattern="yyyy_MM_dd"/>
		</tstamp>
		<property name="year" value="2001-${now}"/>
		<property name="scriptographer" value=":pserver:anonymous@cvs.sourceforge.net:/cvsroot/scriptographer"/>
		<property name="cvs.apps.tag" value="HEAD"/>

		<property name="home.dir" value="../.."/>
		<property name="build.dir" value="${home.dir}/build/java/build"/>
		<property name="build.src" value="${home.dir}/src/java"/>
		<property name="build.lib" value="${build.dir}/lib"/>
		<property name="build.jni" value="${home.dir}/src/cpp/jni"/>
		<property name="build.classes" value="${build.dir}/classes"/>
		<property name="build.packages" value="${home.dir}/build/packages"/>
		<loadproperties srcfile="build.number"/>

		<path id="build.classpath">
			<fileset dir="${build.dir}/lib">
				<exclude name="**/scriptographer*.jar" />
				<include name="**/*.jar" />
			</fileset>
		</path>
		
		<path id="build.sourcepath" >
			<pathelement location="${build.src}" />
			<pathelement location="${build.src.jdk}" />
		</path>

		<property name="docs.dir" value="${home.dir}/docs"/>
		<property name="docs.api.dir" value="${docs.dir}/api"/>
		<property name="docs.js.dir" value="${docs.dir}/js"/>
		<property name="docs.templates.dir" value="${docs.dir}/templates"/>

		<property name="scripts.dir" value="${home.dir}/scripts"/>

		<!-- this is used for importing comments from the gnu classpath file into the js documentation -->
		<property name="build.src.jdk" value="${docs.dir}/src"/>

		<property name="jar.name" value="${project}"/>
		<property name="package.name" value="${project}-${version}"/>

		<property name="debug" value="on"/>
		<property name="optimize" value="on"/>
		<property name="target" value="1.4"/>
		<property name="deprecation" value="off"/>
		
	</target>


	<!-- =================================================================== -->
	<!-- Help on usage                                                       -->
	<!-- =================================================================== -->
	<target name="help" depends="usage" />
	<target name="usage">
		<echo message=""/>
		<echo message=""/>
		<echo message="Scriptographer build instructions"/>
		<echo message="-------------------------------------------------------------"/>
		<echo message=""/>
		<echo message=" available targets are:"/>
		<echo message=""/>
		<echo message=" compile    --> compiles the source code to ./classes"/>
		<echo message=" jar        --> generates the ./lib/scriptographer.jar file"/>
		<echo message=" install    --> installs the jar files in the Adobe Illustrator directory "/>
		<echo message=" jni        --> generates jni headers and registerNatives.cpp in ./jni/"/>
		<echo message=" jnibodies  --> generates empty jni bodies in ./jni/"/>
		<echo message=" javadocs   --> generates the API docs"/>
		<echo message=" docs       --> tries to retrieve the HTML documentation "/>
		<echo message="                (may need proxy settings in startscript)"/>
		<echo message=""/>
		<echo message=" usage	      --> provides help on using the build tool (default)"/>
		<echo message=""/>
		<echo message=" See comments inside the build.xml file for more details."/>
		<echo message="-------------------------------------------------------------"/>
		<echo message=""/>
		<echo message=""/>
	</target>


	<!-- =================================================================== -->
	<!-- Compiles the source directory                                       -->
	<!-- =================================================================== -->
	<target name="compile" depends="init">
		<mkdir dir="${build.classes}"/>
		<!-- copy the icc profiles -->
		<copy todir="${build.classes}/com/scriptographer/cmm">
			<fileset dir="${build.src}/com/scriptographer/cmm">
				<include name="**/*.icc" />
			</fileset>
		</copy>
		<!-- copy the gui resources -->
		<copy todir="${build.classes}/com/scriptographer/gui/resources">
			<fileset dir="${build.src}/com/scriptographer/gui/resources">
				<include name="**/*.png" />
			</fileset>
		</copy>
		<javac srcdir="${build.src}"
			destdir="${build.classes}"
			debug="${debug}"
			deprecation="${deprecation}"
			optimize="${optimize}"
			source="${target}"
			target="${target}">
			<classpath refid="build.classpath" />
			<exclude name="**/global.java"/>
		</javac>
	</target>


	<!-- =================================================================== -->
	<!-- Creates scriptographer.jar and loader.jar in the lib-directory      -->
	<!-- =================================================================== -->
	<target name="jar" depends="compile">
		<copy todir="${build.classes}/com/scriptographer/cmm">
			<fileset dir="${build.src}/com/scriptographer/cmm">
				<include name="**/*.icc" />
			</fileset>
		</copy>
		<jar jarfile="${build.lib}/${jar.name}.jar"
			basedir="${build.classes}"
			excludes="**/loader/**,**/test/**"/>
		<jar jarfile="${build.dir}/loader.jar"
			basedir="${build.classes}"
			includes="**/loader/**"/>
	</target>


	<!-- =================================================================== -->
	<!-- Increases the build.number by one. Execute only before publishing   -->
	<!-- a new version.                                                      -->
	<!-- =================================================================== -->
	<target name="buildnumber">
		<propertyfile file="build.number" comment="Build Number for Scriptographer Plugin.">
			  <entry  key="build.number" type="int" default="000" operation="+" pattern="000" />
		</propertyfile>
		<antcall target="resources" />
	</target>
	
	<target name="resources" depends="init">
		<property name="mac.resources" value="${home.dir}/build/mac/resources" />
		<property name="win.resources" value="${home.dir}/build/win/resources" />
		<copy file="${mac.resources}/Info.plist.in" tofile="${mac.resources}/Info.plist" overwrite="true" />
		<replace file="${mac.resources}/Info.plist">
			<replacefilter token="@version@" value="${version}" />
			<replacefilter token="@build.number@" value="${build.number}" />
			<replacefilter token="@year@" value="${year}" />
		</replace>
		<copy file="${win.resources}/plugin.rc.in" tofile="${win.resources}/plugin.rc" overwrite="true" />
		<replace file="${win.resources}/plugin.rc">
			<replacefilter token="@version.major@" value="${version.major}" />
			<replacefilter token="@version.minor@" value="${version.minor}" />
			<replacefilter token="@build.number@" value="${build.number}" />
			<replacefilter token="@year@" value="${year}" />
		</replace>
	</target>

	<!-- =================================================================== -->
	<!-- Creates install packages of Scriptographer for download             -->
	<!-- =================================================================== -->
	<target name="packages" depends="jar,jsdocs">
		<mkdir dir="${build.packages}"/>

		<mkdir dir="${build.packages}/Scriptographer"/>
		<mkdir dir="${build.packages}/Scriptographer/java"/>
		<copy todir="${build.packages}/Scriptographer/java">
			<fileset dir="${build.dir}">
				<include name="**/loader.jar"/>
				<include name="**/jvm.ini"/>
				<include name="**/${jar.name}.jar"/>
				<include name="**/js.jar"/>
			</fileset>
		</copy>
		<!-- js docs -->
		<copy todir="${build.packages}/Scriptographer/doc">
			<fileset dir="${docs.js.dir}"/>
		</copy>
		<!-- scripts -->
		<copy todir="${build.packages}/Scriptographer/scripts">
			<fileset dir="${scripts.dir}">
				<exclude name="**/*.ai"/>
			</fileset>
		</copy>

		<!-- Macintosh -->
		<exec executable="${home.dir}/build/mac/zipPackages.sh" os="Mac OS X" dir="${build.packages}">
			<arg path="${home.dir}/build/mac/build"/>
			<arg line="${version}.${build.number}"/>
		</exec>

		<!-- Windows -->
		<exec executable="cmd.exe" os="Windows XP" dir="${build.packages}">
			<arg line="/C"/>
			<arg path="${home.dir}/build/win/zipPackages.bat"/>
			<arg path="${home.dir}/build/win"/>
			<arg line="${version}.${build.number}"/>
		</exec>

		<!-- remove everything except the archives -->
		<delete includeEmptyDirs="true">
			<fileset dir="${build.packages}" excludes="**/Scriptographer*.zip"/>
		</delete>
	</target>


	<!-- =================================================================== -->
	<!-- Compiles the source directory                                       -->
	<!-- =================================================================== -->
	<target name="jni" depends="compile">
		<mkdir dir="${build.jni}"/>
		<javah destdir="${build.jni}" classpath="${build.classes}">
			<classpath refid="build.classpath" />

			<class name="com.scriptographer.ScriptographerEngine" />

			<class name="com.scriptographer.ai.Tool" />
			<class name="com.scriptographer.ai.Art" />
			<class name="com.scriptographer.ai.Path" />
			<class name="com.scriptographer.ai.PathStyle" />
			<class name="com.scriptographer.ai.Group" />
			<class name="com.scriptographer.ai.Raster" />
			<class name="com.scriptographer.ai.SegmentList" />
			<class name="com.scriptographer.ai.Curve" />
			<class name="com.scriptographer.ai.ArtSet" />
			<class name="com.scriptographer.ai.Layer" />
			<class name="com.scriptographer.ai.LayerList" />
			<class name="com.scriptographer.ai.Document" />
			<class name="com.scriptographer.ai.DocumentList" />
			<class name="com.scriptographer.ai.View" />
			<class name="com.scriptographer.ai.ViewList" />
			<class name="com.scriptographer.ai.Color" />
			<class name="com.scriptographer.ai.Pathfinder" />
			<class name="com.scriptographer.ai.LiveEffect" />
			<class name="com.scriptographer.ai.Timer" />
			<class name="com.scriptographer.ai.Annotator" />
			<class name="com.scriptographer.ai.TextFrame" />
			<class name="com.scriptographer.ai.PointText" />
			<class name="com.scriptographer.ai.AreaText" />
			<class name="com.scriptographer.ai.PathText" />
			<class name="com.scriptographer.ai.TextRange" />
			<class name="com.scriptographer.ai.TextStory" />
			<class name="com.scriptographer.ai.TextStoryList" />
			<class name="com.scriptographer.ai.CharacterStyle" />
			<class name="com.scriptographer.ai.ParagraphStyle" />
			<class name="com.scriptographer.ai.FontList" />
			<class name="com.scriptographer.ai.FontFamily" />
			<class name="com.scriptographer.ai.FontWeight" />
			<class name="com.scriptographer.ai.Tracing" />

			<class name="com.scriptographer.adm.Notifier" />
			<class name="com.scriptographer.adm.Dialog" />
			<class name="com.scriptographer.adm.ModalDialog" />
			<class name="com.scriptographer.adm.Item" />
		   	<class name="com.scriptographer.adm.ValueItem" />
		   	<class name="com.scriptographer.adm.TextValueItem" />
		   	<class name="com.scriptographer.adm.TextItem" />
		   	<class name="com.scriptographer.adm.Button" />
			<class name="com.scriptographer.adm.ToggleItem" />
			<class name="com.scriptographer.adm.ItemGroup" />
		   	<class name="com.scriptographer.adm.ImageStatic" />
		   	<class name="com.scriptographer.adm.TextEdit" />

		   	<class name="com.scriptographer.adm.ListItem" />
		   	<class name="com.scriptographer.adm.ListEntry" />
		   	<class name="com.scriptographer.adm.HierarchyList" />
		   	<class name="com.scriptographer.adm.HierarchyListEntry" />

		   	<class name="com.scriptographer.adm.Drawer" />
		   	<class name="com.scriptographer.adm.Image" />
		   	<class name="com.scriptographer.adm.Tracker" />

			<class name="com.scriptographer.adm.MenuItem" />
			<class name="com.scriptographer.adm.MenuGroup" />

			<class name="com.scriptographer.adm.Key" />
		</javah>
		<echo id="echo" level="info" />
		<script language="javascript" src="jni.js">
		<![CDATA[
			// create registerNatives.cpp by parsing the generated files by javah, see jni.js:
			registerNatives(project.getProperty("build.jni"), project.getProperty("build.jni") + "/registerNatives.cpp");
		]]>
		</script>
	</target>


	<!-- =================================================================== -->
	<!-- Compiles the source directory                                       -->
	<!-- =================================================================== -->
	<target name="jnibodies" depends="jni">
		<script language="javascript" src="jni.js">
		<![CDATA[
			// create jni bodies by parsing the generated files by javah, see jni.js:
			createJniBodies(project.getProperty("build.jni"));
		]]>
		</script>
	</target>


	<!-- =================================================================== -->
	<!-- Creates the API documentation                                       -->
	<!-- =================================================================== -->
	<target name="javadocs" depends="init">
		<mkdir dir="${docs.api.dir}"/>
		<javadoc packagenames="com.scriptographer.*"
  				sourcepathref="build.sourcepath"
				destdir="${docs.api.dir}"
				author="false"
				version="false"
				private="false"
				windowtitle="${Name} ${version} API"
				classpathref="build.classpath">
		    <doctitle><![CDATA[${Name} ${version}]]></doctitle>
		    <bottom><![CDATA[Copyright &#169; ${year} J&uuml;rg Lehni, <a href="http://www.scratchdisk.com" target="_blank">Scratchdisk.com</a>. All Rights Reserved.]]></bottom>
		</javadoc>
	</target>


	<!-- "java.awt.geom.*,com.scriptographer,com.scriptographer.ai.*,com.scriptographer.adm.*" -->
	<target name="jsdoclet">
		<mkdir dir="${destdir}"/>
		<javadoc packagenames="com.scriptographer,com.scriptographer.ai,com.scriptographer.adm,com.scriptographer.util,java.*"
				sourcepathref="build.sourcepath"
				destdir="${destdir}"
				author="false"
				version="false"
				public="true"
				windowtitle="${Name} ${version} API"
				classpathref="build.classpath">
		    <doctitle><![CDATA[${Name} ${version}]]></doctitle>
			<bottom><![CDATA[Copyright &#169; ${year} J&uuml;rg Lehni, <a href="http://www.scratchdisk.com" target="_blank">Scratchdisk.com</a>. All Rights Reserved.]]></bottom>
			<doclet name="com.scriptographer.doclets.JSDoclet" path="${build.classes}">
				<param name="-basepackage" value="com.scriptographer"/>
				<param name="-filterclasses" value="
					com.scriptographer.Commitable
					com.scriptographer.CommitManager
					com.scriptographer.ConsoleOutputStream
					com.scriptographer.ConsoleOutputWriter
					com.scriptographer.GlobalObject
					com.scriptographer.ScriptographerEngine
					com.scriptographer.ScriptographerException
					com.scriptographer.ai.DictionaryObject
					com.scriptographer.ai.SegmentPoint
					com.scriptographer.ai.Dictionary
					com.scriptographer.ai.Event
					com.scriptographer.ai.TabletValue
					com.scriptographer.ai.Tool
					com.scriptographer.aicw.FileFormat
					com.scriptographer.adm.Notifier
					com.scriptographer.adm.DialogGroupInfo
					com.scriptographer.js.*
					com.scriptographer.util.*
					com.scriptographer.test.*
					java.*
				"/>
				<param name="-packagesequence" value="
					com.scriptographer.ai
					com.scriptographer.adm
				"/>
				<param name="-methodfilter" value="
					setWrapper
					getWrapper
					createWrapper
					iterator
					hashCode
					destroyAll
					disposeAll
					removeAll
					getInstance
				"/>
				<param name="-classorder" value="${home.dir}/build/java/classorder.txt"/>
				<param name="-templates" value="${templates}"/>
			</doclet>
		</javadoc>
	</target>


	<!-- =================================================================== -->
	<!-- Creates the JS API documentation                                    -->
	<!-- =================================================================== -->
	<target name="jsdocs" depends="init">
		<mkdir dir="${docs.js.dir}/packages"/>
		<antcall target="jsdoclet">
			<param name="templates" value="off"/>
			<param name="destdir" value="${docs.js.dir}"/>
		</antcall>
	</target>


	<!-- =================================================================== -->
	<!-- Creates the JS API documentation as Templates for the Server        -->
	<!-- =================================================================== -->
	<target name="templatedocs" depends="init">
		<antcall target="jsdoclet">
			<param name="templates" value="on"/>
			<param name="destdir" value="${docs.templates.dir}"/>
		</antcall>
	</target>
</project>

